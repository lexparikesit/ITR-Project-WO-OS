{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 55, "column": 0}, "map": {"version":3,"sources":["file:///C:/Project/web-ops/src/app/api/cases/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { cookies } from \"next/headers\";\r\n\r\nfunction safeJson(s: string) { try { return JSON.parse(s); } catch { return s; } }\r\nfunction extractArray(raw: any): any[] {\r\n  if (Array.isArray(raw)) return raw;\r\n  if (Array.isArray(raw?.data)) return raw.data;\r\n  if (Array.isArray(raw?.items)) return raw.items;\r\n  if (Array.isArray(raw?.rows)) return raw.rows;\r\n  if (raw?.result && Array.isArray(raw.result)) return raw.result;\r\n  return [];\r\n}\r\nfunction joinPath(basePath: string, add: string) {\r\n  const a = basePath.endsWith(\"/\") ? basePath.slice(0, -1) : basePath;\r\n  const b = add.startsWith(\"/\") ? add.slice(1) : add;\r\n  return `${a}/${b}`;\r\n}\r\nfunction cmp(a: any, b: any) {\r\n  // nulls last\r\n  if (a == null && b == null) return 0;\r\n  if (a == null) return 1;\r\n  if (b == null) return -1;\r\n  // date\r\n  const ad = typeof a === \"string\" && /^\\d{4}-\\d{2}-\\d{2}T/.test(a) ? Date.parse(a) : NaN;\r\n  const bd = typeof b === \"string\" && /^\\d{4}-\\d{2}-\\d{2}T/.test(b) ? Date.parse(b) : NaN;\r\n  if (!Number.isNaN(ad) && !Number.isNaN(bd)) return ad - bd;\r\n  // number\r\n  if (typeof a === \"number\" && typeof b === \"number\") return a - b;\r\n  // string\r\n  return String(a).localeCompare(String(b));\r\n}\r\n\r\nexport async function GET(req: NextRequest) {\r\n  const baseStr = process.env.WAREHOUSE_API_BASE;\r\n  const pathStr = process.env.WAREHOUSE_CASES_PATH || \"/workorder/outstanding/itr\";\r\n  if (!baseStr) return NextResponse.json({ error: \"WAREHOUSE_API_BASE missing\" }, { status: 500 });\r\n\r\n  const wtoken = (await cookies()).get(\"wtoken\")?.value;\r\n  if (!wtoken) return NextResponse.json({ error: \"No warehouse token\" }, { status: 401 });\r\n\r\n  try {\r\n    const sp = req.nextUrl.searchParams;\r\n    const page  = Number(sp.get(\"page\")  ?? \"1\");\r\n    const limit = Number(sp.get(\"limit\") ?? \"50\");\r\n    const caseId = sp.get(\"caseId\") ?? \"\";\r\n    const ageingType = sp.get(\"ageingType\") ?? \"ALL\";\r\n    const site = sp.get(\"site\") ?? \"ALL\";\r\n\r\n    // NEW: global search + sorting\r\n    const q = (sp.get(\"q\") ?? \"\").trim().toLowerCase();\r\n    const orderBy = sp.get(\"orderBy\") ?? \"createdAt\";\r\n    const orderDir = (sp.get(\"orderDir\") ?? \"desc\").toLowerCase() === \"asc\" ? \"asc\" : \"desc\";\r\n\r\n    const u = new URL(baseStr);\r\n    u.pathname = joinPath(u.pathname, pathStr);\r\n    if (caseId) u.searchParams.set(\"caseid\", caseId);\r\n    if (ageingType && ageingType !== \"ALL\") u.searchParams.set(\"ageingtype\", ageingType);\r\n    if (site && site !== \"ALL\") u.searchParams.set(\"site\", site);\r\n\r\n    const upstream = await fetch(u.toString(), {\r\n      headers: { Authorization: `Bearer ${wtoken}`, Accept: \"application/json\" },\r\n      cache: \"no-store\",\r\n    });\r\n\r\n    const text = await upstream.text();\r\n    if (!upstream.ok) {\r\n      return NextResponse.json(\r\n        { error: \"Upstream error\", status: upstream.status, url: u.toString(), body: safeJson(text) },\r\n        { status: upstream.status }\r\n      );\r\n    }\r\n\r\n    const raw = safeJson(text);\r\n    const rows = extractArray(raw);\r\n\r\n    // === NORMALISASI ke shape yang dipakai tabel ===\r\n    const normalized = rows.map((r: any, idx: number) => ({\r\n      id: String(r.CASEID ?? r.caseid ?? r[\"DEVICE NUMBER\"] ?? idx + 1),\r\n      caseId: r.CASEID ?? r.caseid ?? \"\",\r\n      description: r.DESCRIPTION ?? r.description ?? \"\",\r\n      deliveryName: r.DELIVERYNAME ?? r.deliveryName ?? \"\",\r\n      deviceNumber: r[\"DEVICE NUMBER\"] ?? r.deviceNumber ?? \"\",\r\n      serialNumber: r[\"SERIAL NUMBER\"] ?? r.serialNumber ?? \"\",\r\n      brand: r.BRAND ?? r.brand ?? \"\",\r\n      createdAt: r.CREATEDDATETIME ?? r.createdAt ?? r.created_at ?? null,\r\n      ageing: r.aging ?? r.ageing ?? null,\r\n      ageingType: r.ageingType ?? r.AGEINGTYPE ?? r.agingType ?? \"\",\r\n      warehouseName: r.warehouseName ?? r.WAREHOUSENAME ?? \"\",\r\n      siteName: r.siteName ?? r.SITENAME ?? \"\",\r\n      statusWo: r[\"STATUS WO\"] ?? r.status ?? \"\",\r\n      site: r.site ?? r.SITE ?? \"\",\r\n      warehouse: r.warehouse ?? r.WAREHOUSE ?? \"\",\r\n    }));\r\n\r\n    // === FILTER (global search q) ===\r\n    const filtered = q\r\n      ? normalized.filter((x) => {\r\n          const hay = `${x.caseId} ${x.description} ${x.deliveryName} ${x.deviceNumber} ${x.site} ${x.siteName} ${x.warehouseName} ${x.statusWo}`.toLowerCase();\r\n          return hay.includes(q);\r\n        })\r\n      : normalized;\r\n\r\n    // === SORT ===\r\n    const sorted = [...filtered].sort((a, b) => {\r\n      const diff = cmp((a as any)[orderBy], (b as any)[orderBy]);\r\n      return orderDir === \"asc\" ? diff : -diff;\r\n    });\r\n\r\n    // === PAGING ===\r\n    const total = sorted.length;\r\n    const start = Math.max(0, (page - 1) * limit);\r\n    const data = sorted.slice(start, start + limit);\r\n\r\n    return NextResponse.json({ data, page, limit, total });\r\n  } catch (err: any) {\r\n    return NextResponse.json({ error: err?.message ?? \"Internal error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,SAAS,SAAS,CAAS;IAAI,IAAI;QAAE,OAAO,KAAK,KAAK,CAAC;IAAI,EAAE,OAAM;QAAE,OAAO;IAAG;AAAE;AACjF,SAAS,aAAa,GAAQ;IAC5B,IAAI,MAAM,OAAO,CAAC,MAAM,OAAO;IAC/B,IAAI,MAAM,OAAO,CAAC,KAAK,OAAO,OAAO,IAAI,IAAI;IAC7C,IAAI,MAAM,OAAO,CAAC,KAAK,QAAQ,OAAO,IAAI,KAAK;IAC/C,IAAI,MAAM,OAAO,CAAC,KAAK,OAAO,OAAO,IAAI,IAAI;IAC7C,IAAI,KAAK,UAAU,MAAM,OAAO,CAAC,IAAI,MAAM,GAAG,OAAO,IAAI,MAAM;IAC/D,OAAO,EAAE;AACX;AACA,SAAS,SAAS,QAAgB,EAAE,GAAW;IAC7C,MAAM,IAAI,SAAS,QAAQ,CAAC,OAAO,SAAS,KAAK,CAAC,GAAG,CAAC,KAAK;IAC3D,MAAM,IAAI,IAAI,UAAU,CAAC,OAAO,IAAI,KAAK,CAAC,KAAK;IAC/C,OAAO,GAAG,EAAE,CAAC,EAAE,GAAG;AACpB;AACA,SAAS,IAAI,CAAM,EAAE,CAAM;IACzB,aAAa;IACb,IAAI,KAAK,QAAQ,KAAK,MAAM,OAAO;IACnC,IAAI,KAAK,MAAM,OAAO;IACtB,IAAI,KAAK,MAAM,OAAO,CAAC;IACvB,OAAO;IACP,MAAM,KAAK,OAAO,MAAM,YAAY,sBAAsB,IAAI,CAAC,KAAK,KAAK,KAAK,CAAC,KAAK;IACpF,MAAM,KAAK,OAAO,MAAM,YAAY,sBAAsB,IAAI,CAAC,KAAK,KAAK,KAAK,CAAC,KAAK;IACpF,IAAI,CAAC,OAAO,KAAK,CAAC,OAAO,CAAC,OAAO,KAAK,CAAC,KAAK,OAAO,KAAK;IACxD,SAAS;IACT,IAAI,OAAO,MAAM,YAAY,OAAO,MAAM,UAAU,OAAO,IAAI;IAC/D,SAAS;IACT,OAAO,OAAO,GAAG,aAAa,CAAC,OAAO;AACxC;AAEO,eAAe,IAAI,GAAgB;IACxC,MAAM,UAAU,QAAQ,GAAG,CAAC,kBAAkB;IAC9C,MAAM,UAAU,QAAQ,GAAG,CAAC,oBAAoB,IAAI;IACpD,IAAI,CAAC,SAAS,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAA6B,GAAG;QAAE,QAAQ;IAAI;IAE9F,MAAM,SAAS,CAAC,MAAM,IAAA,4IAAO,GAAE,EAAE,GAAG,CAAC,WAAW;IAChD,IAAI,CAAC,QAAQ,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAqB,GAAG;QAAE,QAAQ;IAAI;IAErF,IAAI;QACF,MAAM,KAAK,IAAI,OAAO,CAAC,YAAY;QACnC,MAAM,OAAQ,OAAO,GAAG,GAAG,CAAC,WAAY;QACxC,MAAM,QAAQ,OAAO,GAAG,GAAG,CAAC,YAAY;QACxC,MAAM,SAAS,GAAG,GAAG,CAAC,aAAa;QACnC,MAAM,aAAa,GAAG,GAAG,CAAC,iBAAiB;QAC3C,MAAM,OAAO,GAAG,GAAG,CAAC,WAAW;QAE/B,+BAA+B;QAC/B,MAAM,IAAI,CAAC,GAAG,GAAG,CAAC,QAAQ,EAAE,EAAE,IAAI,GAAG,WAAW;QAChD,MAAM,UAAU,GAAG,GAAG,CAAC,cAAc;QACrC,MAAM,WAAW,CAAC,GAAG,GAAG,CAAC,eAAe,MAAM,EAAE,WAAW,OAAO,QAAQ,QAAQ;QAElF,MAAM,IAAI,IAAI,IAAI;QAClB,EAAE,QAAQ,GAAG,SAAS,EAAE,QAAQ,EAAE;QAClC,IAAI,QAAQ,EAAE,YAAY,CAAC,GAAG,CAAC,UAAU;QACzC,IAAI,cAAc,eAAe,OAAO,EAAE,YAAY,CAAC,GAAG,CAAC,cAAc;QACzE,IAAI,QAAQ,SAAS,OAAO,EAAE,YAAY,CAAC,GAAG,CAAC,QAAQ;QAEvD,MAAM,WAAW,MAAM,MAAM,EAAE,QAAQ,IAAI;YACzC,SAAS;gBAAE,eAAe,CAAC,OAAO,EAAE,QAAQ;gBAAE,QAAQ;YAAmB;YACzE,OAAO;QACT;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAAkB,QAAQ,SAAS,MAAM;gBAAE,KAAK,EAAE,QAAQ;gBAAI,MAAM,SAAS;YAAM,GAC5F;gBAAE,QAAQ,SAAS,MAAM;YAAC;QAE9B;QAEA,MAAM,MAAM,SAAS;QACrB,MAAM,OAAO,aAAa;QAE1B,kDAAkD;QAClD,MAAM,aAAa,KAAK,GAAG,CAAC,CAAC,GAAQ,MAAgB,CAAC;gBACpD,IAAI,OAAO,EAAE,MAAM,IAAI,EAAE,MAAM,IAAI,CAAC,CAAC,gBAAgB,IAAI,MAAM;gBAC/D,QAAQ,EAAE,MAAM,IAAI,EAAE,MAAM,IAAI;gBAChC,aAAa,EAAE,WAAW,IAAI,EAAE,WAAW,IAAI;gBAC/C,cAAc,EAAE,YAAY,IAAI,EAAE,YAAY,IAAI;gBAClD,cAAc,CAAC,CAAC,gBAAgB,IAAI,EAAE,YAAY,IAAI;gBACtD,cAAc,CAAC,CAAC,gBAAgB,IAAI,EAAE,YAAY,IAAI;gBACtD,OAAO,EAAE,KAAK,IAAI,EAAE,KAAK,IAAI;gBAC7B,WAAW,EAAE,eAAe,IAAI,EAAE,SAAS,IAAI,EAAE,UAAU,IAAI;gBAC/D,QAAQ,EAAE,KAAK,IAAI,EAAE,MAAM,IAAI;gBAC/B,YAAY,EAAE,UAAU,IAAI,EAAE,UAAU,IAAI,EAAE,SAAS,IAAI;gBAC3D,eAAe,EAAE,aAAa,IAAI,EAAE,aAAa,IAAI;gBACrD,UAAU,EAAE,QAAQ,IAAI,EAAE,QAAQ,IAAI;gBACtC,UAAU,CAAC,CAAC,YAAY,IAAI,EAAE,MAAM,IAAI;gBACxC,MAAM,EAAE,IAAI,IAAI,EAAE,IAAI,IAAI;gBAC1B,WAAW,EAAE,SAAS,IAAI,EAAE,SAAS,IAAI;YAC3C,CAAC;QAED,mCAAmC;QACnC,MAAM,WAAW,IACb,WAAW,MAAM,CAAC,CAAC;YACjB,MAAM,MAAM,GAAG,EAAE,MAAM,CAAC,CAAC,EAAE,EAAE,WAAW,CAAC,CAAC,EAAE,EAAE,YAAY,CAAC,CAAC,EAAE,EAAE,YAAY,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,CAAC,EAAE,EAAE,QAAQ,CAAC,CAAC,EAAE,EAAE,aAAa,CAAC,CAAC,EAAE,EAAE,QAAQ,EAAE,CAAC,WAAW;YACnJ,OAAO,IAAI,QAAQ,CAAC;QACtB,KACA;QAEJ,eAAe;QACf,MAAM,SAAS;eAAI;SAAS,CAAC,IAAI,CAAC,CAAC,GAAG;YACpC,MAAM,OAAO,IAAI,AAAC,CAAS,CAAC,QAAQ,EAAE,AAAC,CAAS,CAAC,QAAQ;YACzD,OAAO,aAAa,QAAQ,OAAO,CAAC;QACtC;QAEA,iBAAiB;QACjB,MAAM,QAAQ,OAAO,MAAM;QAC3B,MAAM,QAAQ,KAAK,GAAG,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI;QACvC,MAAM,OAAO,OAAO,KAAK,CAAC,OAAO,QAAQ;QAEzC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;YAAM;YAAM;YAAO;QAAM;IACtD,EAAE,OAAO,KAAU;QACjB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,KAAK,WAAW;QAAiB,GAAG;YAAE,QAAQ;QAAI;IACtF;AACF","debugId":null}}]
}